#!/usr/bin/perl

# Verify the Markdown files for security advisories

# These sections must exist, in this order
my @sections = (
    "VULNERABILITY",
    "INFO",
    "AFFECTED VERSIONS",
    "SOLUTION",
    "TIMELINE",
    "CREDITS"
    );

sub checkfile {
    my ($file) = @_;
    open(F, "<$file");
    my $i = 0;
    my $line = 0;
    my ($cwefound, $affected, $notaffected, $firstaff);
    my @secline;
    while(<F>) {
        my $l = $_;
        $line++;
        if($l =~ /^$sections[$i]/) {
            $secline[$i]= $line;
            $i++;
            last if($i == 6);
        }
        if($l =~ /^ *CWE-(\d+):/) {
            $cwefound = 1;
        }
        if($l =~ /^- Affected versions: [^0-9]*([0-9.]+) to and including .*/) {
            $firstaff = $1;
            $affected = 1;
        }
        if($firstaff eq "4.0") {
            # special case if existing from 4.0
            if($l =~ /^- Not affected versions: .* >= /) {
                $notaffected = 1;
            }
        }
        elsif($l =~ /^- Not affected versions: .* < .* and .*>= /) {
            $notaffected = 1;
        }
    }
    close(F);
    if($i != 6) {
        printf STDERR "$file:%d:error: No %s section after %s\n",
            $i ? $secline[$i-1]: 0,
            $sections[$i], $i? $sections[$i -1 ] : "start";
        return 1;
    }
    elsif(!$cwefound) {
        printf STDERR "$file:%d:error: No CWE found in INFO\n",
            $secline[2];
        return 1;
    }
    elsif(!$affected) {
        printf STDERR "$file:%d:error: \"affected versions\" not found in AFFECTED VERSIONS\n",
            $secline[3];
        return 1;
    }
    elsif(!$notaffected) {
        printf STDERR "$file:%d:error: \"not affected versions\" not found in AFFECTED VERSIONS [$firstaff]\n",
            $secline[3];
        return 1;
    }
    return 0;
}

exit checkfile($ARGV[0]);

