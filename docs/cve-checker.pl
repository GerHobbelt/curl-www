#!/usr/bin/perl

# Verify the Markdown files for security advisories

# These sections must exist, in this order
my @sections = (
    "VULNERABILITY",
    "INFO",
    "AFFECTED VERSIONS",
    "SOLUTION",
    "TIMELINE",
    "CREDITS"
    );

sub checkfile {
    my ($file) = @_;
    open(F, "<$file");
    my $i = 0;
    my $line = 0;
    my $cwefound = 0;
    my @secline;
    while(<F>) {
        my $l = $_;
        $line++;
        if($l =~ /^$sections[$i]/) {
            $secline[$i]= $line;
            $i++;
            last if($i == 6);
        }
        if($l =~ /^ *CWE-(\d+):/) {
            $cwefound = 1;
        }
    }
    close(F);
    if($i != 6) {
        printf STDERR "$file:%d:error: No %s section after %s\n",
            $i ? $secline[$i-1]: 0,
            $sections[$i], $i? $sections[$i -1 ] : "start";
        return 1;
    }
    elsif(!$cwefound) {
        printf STDERR "$file:%d:error: No CWE found in INFO\n",
            $secline[2];
        return 1;
    }
    return 0;
}

exit checkfile($ARGV[0]);

